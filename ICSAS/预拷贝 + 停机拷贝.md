---
title: æœªå‘½å
date: 2025-09-01 16:36:18
modify: 2025-09-01 16:36:18
author: days
category: ICSAS
published: 2025-09-01
draft: false
---

ä½ è¯´å¾—éå¸¸å¯¹ï¼æˆ‘ä¹‹å‰çš„åˆ†æä¸å¤Ÿå‡†ç¡®ã€‚çƒ­è¿ç§»ç¡®å®ä¸æ˜¯ç«‹å³åœæœºçš„ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªé¢„æ‹·è´ + åœæœºæ‹·è´çš„ä¸¤é˜¶æ®µè¿‡ç¨‹ã€‚è®©æˆ‘é‡æ–°åˆ†ææ­£ç¡®çš„è°ƒç”¨æ—¶æœºï¼š

## æ­£ç¡®çš„çƒ­è¿ç§»åœæœºæ—¶æœº

### 1. çƒ­è¿ç§»çš„ä¸¤ä¸ªé˜¶æ®µ

#### é˜¶æ®µ 1ï¼šé¢„æ‹·è´é˜¶æ®µï¼ˆVM ç»§ç»­è¿è¡Œï¼‰

```
// migration/migration.c:3487-3495
while (migration_is_active()) {
    if (urgent || !migration_rate_exceeded(s->to_dst_file)) {
        // ğŸ”„ æŒç»­æ‹·è´è„é¡µï¼ŒVMç»§ç»­è¿è¡Œ
        MigIterateState iter_state = migration_iteration_run(s);
        if (iter_state == MIG_ITERATE_BREAK) {
            break;  // è„å†…å­˜è¶³å¤Ÿå°‘äº†ï¼Œè¿›å…¥åœæœºé˜¶æ®µ
        }
    }
}
```

#### é˜¶æ®µ 2ï¼šåœæœºæ‹·è´é˜¶æ®µï¼ˆVM åœæ­¢ï¼‰

```
// åªæœ‰å½“è„å†…å­˜æ”¶æ•›åˆ°é˜ˆå€¼ä»¥ä¸‹æ—¶ï¼Œæ‰è¿›å…¥completioné˜¶æ®µ
migration_completion(s);
```

### 2. è„å†…å­˜æ”¶æ•›åˆ¤æ–­é€»è¾‘

```
// migration/migration.c:3235-3238
if ((!pending_size || pending_size < s->threshold_size) && can_switchover) {
    trace_migration_thread_low_pending(pending_size);
    // å…³é”®ï¼šåªæœ‰è„å†…å­˜å°‘äºé˜ˆå€¼æ—¶ï¼Œæ‰è°ƒç”¨completion
    migration_completion(s);
    return MIG_ITERATE_BREAK;
}
```

å…³é”®å‚æ•°ï¼š

- `pending_size`ï¼šå¾…ä¼ è¾“çš„è„é¡µå¤§å°
- `s->threshold_size`ï¼šåœæœºé˜ˆå€¼ï¼ˆé€šå¸¸æ˜¯ 64 KBï¼‰
- `can_switchover`ï¼šæ˜¯å¦å¯ä»¥åˆ‡æ¢ï¼ˆæ²¡æœ‰é˜»å¡æ“ä½œï¼‰

### 3. çœŸæ­£çš„åœæœºæ—¶åˆ»

```
// migration/migration.c:2806-2813
static void migration_completion(MigrationState *s)
{
    if (s->state == MIGRATION_STATUS_ACTIVE) {
        // ğŸ¯ è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„åœæœºè°ƒç”¨
        ret = migration_completion_precopy(s, &current_active_state);
    }
}
        â†“
// migration/migration.c:2731
static int migration_completion_precopy(MigrationState *s, ...)
{
    // ğŸ”¥ è¿™é‡Œæ‰è°ƒç”¨VMåœæ­¢
    ret = migration_stop_vm(s, RUN_STATE_FINISH_MIGRATE);
}
```

### 4. å®Œæ•´çš„æ—¶åºæµç¨‹

```
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Migration as è¿ç§»çº¿ç¨‹
    participant VM as è™šæ‹Ÿæœº
    participant ITS as ITSè®¾å¤‡

    User->>Migration: migrateå‘½ä»¤
    Note over Migration: å¯åŠ¨è¿ç§»çº¿ç¨‹ï¼ŒVMç»§ç»­è¿è¡Œ
    
    loop é¢„æ‹·è´é˜¶æ®µ
        Migration->>Migration: migration_iteration_run()
        Migration->>Migration: æ£€æŸ¥pending_size
        alt pending_size > threshold_size
            Migration->>Migration: ç»§ç»­æ‹·è´è„é¡µ
            Note over VM: VMæŒç»­è¿è¡Œï¼Œäº§ç”Ÿæ–°è„é¡µ
        else pending_size < threshold_size
            Migration->>Migration: è„å†…å­˜æ”¶æ•›ï¼Œå‡†å¤‡åœæœº
        end
    end
    
    Migration->>Migration: migration_completion()
    Migration->>VM: migration_stop_vm()
    Note over VM: VMåœæ­¢è¿è¡Œ
    VM->>ITS: vm_change_state_handler(running=false)
    ITS->>ITS: ä¿å­˜ITSè¡¨åˆ°å®¢æˆ·æœºå†…å­˜
    
    Note over Migration: ä¼ è¾“å‰©ä½™è„é¡µå’Œè®¾å¤‡çŠ¶æ€
    Migration->>Migration: è¿ç§»å®Œæˆ
```

### 5. å…³é”®æ—¶é—´ç‚¹

- T 0ï¼šç”¨æˆ·å‘èµ·è¿ç§»ï¼ŒVM ç»§ç»­è¿è¡Œ
- T 1-Tnï¼šé¢„æ‹·è´é˜¶æ®µï¼Œåå¤ä¼ è¾“è„é¡µï¼ŒVM æŒç»­è¿è¡Œ
- Tn+1ï¼šè„å†…å­˜æ”¶æ•›åˆ°é˜ˆå€¼ä»¥ä¸‹
- Tn+2ï¼šVM åœæœº â† `vm_change_state_handler` åœ¨è¿™é‡Œè¢«è°ƒç”¨
- Tn+3ï¼šä¼ è¾“æœ€åçš„è„é¡µå’Œè®¾å¤‡çŠ¶æ€
- Tn+4ï¼šè¿ç§»å®Œæˆ

### 6. ITS è¡¨ä¿å­˜çš„å‡†ç¡®æ—¶æœº

```
// åªæœ‰åœ¨è„å†…å­˜æ”¶æ•›åçš„åœæœºé˜¶æ®µï¼Œæ‰ä¼šè§¦å‘ITSè¡¨ä¿å­˜
migration_iteration_run() 
    â†’ pending_size < threshold_size 
    â†’ migration_completion() 
    â†’ migration_completion_precopy() 
    â†’ migration_stop_vm() 
    â†’ vm_stop_force_state() 
    â†’ do_vm_stop() 
    â†’ vm_state_notify(false, RUN_STATE_FINISH_MIGRATE) 
    â†’ vm_change_state_handler()  // ITSè¡¨ä¿å­˜
```

æ‰€ä»¥ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼VM å¹¶ä¸æ˜¯ç«‹å³åœæœºçš„ï¼Œè€Œæ˜¯ç­‰å¾…è„å†…å­˜æ”¶æ•›åˆ°è¶³å¤Ÿå°çš„ç¨‹åº¦ï¼ˆé€šå¸¸å‡ å KBï¼‰ï¼Œæ‰ä¼šè¿›å…¥åœæœºé˜¶æ®µã€‚åªæœ‰åœ¨è¿™ä¸ªåœæœºé˜¶æ®µï¼Œ`vm_change_state_handler` æ‰ä¼šè¢«è°ƒç”¨ï¼ŒITS è¡¨æ‰ä¼šè¢«ä¿å­˜åˆ°å®¢æˆ·æœºå†…å­˜ä¸­ã€‚

è¿™ç§è®¾è®¡ç¡®ä¿äº†ï¼š

1. æœ€å°åŒ–åœæœºæ—¶é—´ï¼šåªåœ¨è„å†…å­˜å¾ˆå°‘æ—¶æ‰åœæœº
2. æ•°æ®ä¸€è‡´æ€§ï¼šåœ¨ VM åœæ­¢çŠ¶æ€ä¸‹ä¿å­˜ ITS è¡¨ï¼Œé¿å…å¹¶å‘ä¿®æ”¹
3. è¿ç§»æ•ˆç‡ï¼šå¤§éƒ¨åˆ†æ•°æ®åœ¨ VM è¿è¡Œæ—¶å°±å·²ç»ä¼ è¾“å®Œæˆ